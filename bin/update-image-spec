#!/bin/bash

update_values_file () {
   FILE=$1
   export IMAGE=$2

   echo "yq e -i '.app.containers[0].image=strenv(IMAGE)' $FILE"
   yq e -i '.app.containers[0].image=strenv(IMAGE)' $FILE
}

#
# Main program
#

if [ "$#" -eq 3 ]; then
   SRC_FILE=$1
   TRG_FILE=$2
   REGISTRY_NAME=$3

   OLD_IMAGE=$(yq e '.app.containers[0].image' $SRC_FILE)
   NEW_IMAGE=$REGISTRY_NAME.azurecr.io/${OLD_IMAGE#*/}

   if [ "$OLD_IMAGE" != "$NEW_IMAGE" ]; then
      update_values_file $TRG_FILE $NEW_IMAGE
   fi

else
   echo "$0 <source values file> <target values file> <target registry name>"
fi

